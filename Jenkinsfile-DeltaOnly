pipeline {
    agent any

    options {
        timestamps()
        skipDefaultCheckout()
    }

    parameters {

        choice(
            name: 'TARGET_ENV',
            choices: ['DEV', 'QA'],
            description: 'Target Salesforce environment'
        )

        choice(
            name: 'TEST_LEVEL',
            choices: ['NoTestRun', 'RunLocalTests'],
            description: 'Salesforce test level'
        )

        booleanParam(
            name: 'ROLLBACK_MODE',
            defaultValue: false,
            description: 'Enable rollback to previous successful build'
        )

        string(
            name: 'ROLLBACK_TO_BUILD',
            defaultValue: '',
            description: 'Build number to rollback to'
        )
    }

    environment {
        SF              = "/c/Program Files/sf/bin/sf"
        INSTANCE_URL    = "https://login.salesforce.com"

        DELTA_DIR       = "delta"
        SCA_DIR         = "sca-reports"

        SCA_THRESHOLD_HIGH      = "0"
        SCA_THRESHOLD_CRITICAL = "0"

        BUILD_METRICS   = "build-metrics.json"

        CLEAN_BUILD_STREAK      = "0"
        PREVIOUS_BUILD_CLEAN    = "false"

        GIT_COMMIT_HASH = ""
        DELTA_EMPTY     = "false"
    }

    stages {

        /* =========================================================
           Select Git Branch & Baseline
           ========================================================= */
        stage('Select Git Branch') {
            steps {
                script {
                    if (params.TARGET_ENV == 'DEV') {
                        env.GIT_BRANCH   = 'dev'
                        env.BASELINE_TAG = 'dev-baseline'
                        env.SF_ALIAS     = 'DEV'
                    } else {
                        env.GIT_BRANCH   = 'qa'
                        env.BASELINE_TAG = 'qa-baseline'
                        env.SF_ALIAS     = 'QA'
                    }

                    echo "Git Branch   : ${env.GIT_BRANCH}"
                    echo "Baseline Tag : ${env.BASELINE_TAG}"
                }
            }
        }

        /* =========================================================
           Checkout
           ========================================================= */
        stage('Checkout') {
    steps {
        checkout([
            $class: 'GitSCM',
            branches: [[name: "*/${env.GIT_BRANCH}"]],
            userRemoteConfigs: [[
                url: 'https://github.com/manishamondal/salesforce-full.git',
                credentialsId: 'supercred'
            ]]
        ])
    }
}


stage('Capture Git Commit') {
    steps {
        script {
            env.GIT_HEAD = sh(
                script: 'git rev-parse HEAD',
                returnStdout: true
            ).trim()

            echo "üìå Captured Git Commit: ${env.GIT_HEAD}"
        }
    }
}
        /* =========================================================
           Salesforce Authentication (JWT)
           ========================================================= */
        stage('Authenticate to Salesforce') {
            steps {
                withCredentials([
                    file(credentialsId: 'sfdx_jwt_key', variable: 'JWT_KEY_FILE'),
                    string(credentialsId: 'sfdx_client_id', variable: 'CLIENT_ID'),
                    string(credentialsId: 'sfdx_username', variable: 'SF_USERNAME')
                ]) {
                    sh """
                        "$SF" org login jwt \
                          --client-id "$CLIENT_ID" \
                          --jwt-key-file "$JWT_KEY_FILE" \
                          --username "$SF_USERNAME" \
                          --instance-url "$INSTANCE_URL" \
                          --alias "$SF_ALIAS" \
                          --set-default
                    """
                }
            }
        }

        /* =========================================================
           Static Code Analysis
           ========================================================= */
        stage('Static Code Analysis') {
            steps {
                sh """
                    mkdir -p "$SCA_DIR"

                    "$SF" scanner run \
                      --target force-app \
                      --format html \
                      --outfile "$SCA_DIR/sca-report.html" \
                      --severity-threshold 1 \
                      --normalize-severity || true
                """
            }
            post {
                always {
                    archiveArtifacts artifacts: "${SCA_DIR}/**/*", allowEmptyArchive: true
                }
            }
        }

stage('Verify Baseline Tag Exists') {
    steps {
        dir(env.WORKSPACE) {
            sh '''
                git rev-parse ${BASELINE_TAG} > .baseline_check
            '''
        }
    }
}


        /* =========================================================
           Generate Delta
           ========================================================= */
stage('Generate Delta') {
    steps {
        script {
            dir(env.WORKSPACE) {
                sh 'git fetch --tags'
            }

            if (!env.GIT_HEAD?.trim()) {
                error "‚ùå GIT_HEAD is null ‚Äî cannot generate delta"
            }

            sh """
                mkdir -p delta
                "$SF" sgd:source:delta \
                  --from ${env.BASELINE_TAG} \
                  --to ${env.GIT_HEAD} \
                  --output-dir delta \
                  --generate-delta \
                  --source-dir force-app
            """
        }
    }
}


        /* =========================================================
           Check Delta Content
           ========================================================= */
stage('Check Delta Content') {
    steps {
        script {
            def pkg = "${DELTA_DIR}/package/package.xml"

            if (!fileExists(pkg)) {
                env.DELTA_EMPTY = "true"
            } else {
                def typesCount = sh(
                    script: "grep -c '<types>' ${pkg} || true",
                    returnStdout: true
                ).trim().toInteger()

                env.DELTA_EMPTY = (typesCount == 0) ? "true" : "false"
            }

            echo "DELTA_EMPTY = ${env.DELTA_EMPTY}"
        }
    }
}

        /* =========================================================
           Validate Delta Deployment (Dry Run)
           ========================================================= */
stage('Validate Deployment') {
    steps {
        script {
            if (env.DELTA_EMPTY == 'true') {
                echo "‚úÖ Skipping validation ‚Äì delta package is empty"
                return
            }

            def output = ""
            def status = sh(
                script: """
                    set +e
                    "$SF" project deploy start \
                      --manifest ${DELTA_DIR}/package/package.xml \
                      --target-org "$SF_ALIAS" \
                      --test-level "$TEST_LEVEL" \
                      --dry-run \
                      --wait 60
                """,
                returnStatus: true
            )

            if (status != 0) {
                output = sh(
                    script: 'cat .sf/deploy.log 2>/dev/null || true',
                    returnStdout: true
                )

                if (output.contains("NothingToDeploy")) {
                    echo "üü° Nothing to deploy (org already in sync)"
                    env.DELTA_EMPTY = "true"
                } else {
                    error "‚ùå Validation failed for real reasons"
                }
            }
        }
    }
}

        /* =========================================================
           Manual Approval (QA only)
           ========================================================= */
        stage('Approve Deployment') {
            when {
                allOf {
                    expression { params.TARGET_ENV == 'QA' }
                    expression { env.DELTA_EMPTY != 'true' }
                }
            }
            steps {
                input message: "Approve DELTA deployment to QA?", ok: 'Approve'
            }
        }

        /* =========================================================
           Deploy Delta
           ========================================================= */
stage('Deploy') {
    steps {
        script {
            if (env.DELTA_EMPTY == 'true') {
                echo "‚úÖ No-op deployment ‚Äì nothing to deploy"
                return
            }

            sh """
                "$SF" project deploy start \
                  --manifest ${DELTA_DIR}/package/package.xml \
                  --target-org "$SF_ALIAS" \
                  --test-level "$TEST_LEVEL" \
                  --wait 60
            """
        }
    }
}

        /* =========================================================
           Update Baseline Tag
           ========================================================= */
        stage('Update Baseline Tag') {
            when {
                allOf {
                    expression { env.DELTA_EMPTY != 'true' }
                    expression { currentBuild.result == null || currentBuild.result == 'SUCCESS' }
                }
            }
            steps {
                withCredentials([
                    usernamePassword(
                        credentialsId: 'supercred',
                        usernameVariable: 'GIT_USER',
                        passwordVariable: 'GIT_TOKEN'
                    )
                ]) {
                    sh """
                        git config user.name "jenkins-ci"
                        git config user.email "jenkins@ci.com"

                        git tag -f ${BASELINE_TAG}
                        git push https://${GIT_USER}:${GIT_TOKEN}@github.com/manishamondal/salesforce-full.git \
                          ${BASELINE_TAG} --force
                    """
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Delta deployment successful"
        }
        failure {
            echo "‚ùå Delta deployment failed"
        }
    }
}
